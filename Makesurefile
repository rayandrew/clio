@options timing
@options tracing

@define ENV_NAME "clio"
@define PATH "${MAMBA_ROOT_PREFIX}/envs/${ENV_NAME}/bin:${PATH}"
@define CUBLAS_WORKSPACE_CONFIG ":4096:8"
@define TF_CPP_MIN_LOG_LEVEL "3"

############################################################
#                       GENERAL 
############################################################

@goal check_cuda
  echo "CUDA version: $(nvcc --version)"
  python -c "import tensorflow as tf; print(tf.config.list_physical_devices('GPU'))"
  python -c "import torch; print(torch.cuda.is_available())"

############################################################
#                       FLASHNET
############################################################

@goal flashnet_get_alibaba_data
@reached_if [[ -f "raw-data/flashnet/alibaba-data/done" ]]
  mkdir -p "raw-data/flashnet/alibaba-data"
  DIRS=$(ssh -p 23 -m hmac-sha2-512 u369179-sub4@box.rs.ht "ls -d /home/trace_ori_60mins/alibaba.*")
  parallel --jobs 8 --line-buffer "rsync -Pavzr -e 'ssh -p 23 -m hmac-sha2-512' --include='*/' --include='*.labeled' --exclude='*' u369179-sub4@box.rs.ht:{} raw-data/flashnet/alibaba-data" ::: $DIRS
  echo "Alibaba data downloaded" > "raw-data/flashnet/alibaba-data/done"

@goal flashnet_get_msr_data
@reached_if [[ -f "raw-data/flashnet/msr-data/done" ]]
  mkdir -p "raw-data/flashnet/msr-data"
  DIRS=$(ssh -p 23 -m hmac-sha2-512 u369179-sub4@box.rs.ht "ls -d /home/trace_ori_60mins/msr.*")
  parallel --jobs 8 --line-buffer "rsync -Pavzr -e 'ssh -p 23 -m hmac-sha2-512' --include='*/' --include='*.labeled' --exclude='*' u369179-sub4@box.rs.ht:{} raw-data/flashnet/alibaba-data" ::: $DIRS
  echo "MSR data downloaded" > "raw-data/flashnet/msr-data/done"

@goal flashnet_get_tencent_data
@reached_if [[ -f "raw-data/flashnet/tencent-data/done" ]]
  mkdir -p "raw-data/flashnet/tencent-data"
  DIRS=$(ssh -p 23 -m hmac-sha2-512 u369179-sub4@box.rs.ht "ls -d /home/trace_ori_60mins/tencent.*")
  parallel --jobs 8 --line-buffer "rsync -Pavzr -e 'ssh -p 23 -m hmac-sha2-512' --include='*/' --include='*.labeled' --exclude='*' u369179-sub4@box.rs.ht:{} raw-data/flashnet/alibaba-data" ::: $DIRS
  echo "Tencent data downloaded" > "raw-data/flashnet/tencent-data/done"

# ==========================================================
# Experiment: Preprocess 
# ==========================================================

@goal flashnet_preprocess_alibaba_data
@reached_if [[ -f "data/flashnet/preprocess/alibaba.per_60mins.iops_p100.alibaba_9087.1/done" ]]
  python -m clio.flashnet.cli.preprocessing \
      "raw-data/flashnet/alibaba-data/alibaba.per_60mins.iops_p100.alibaba_9087.1" \
      --output "data/flashnet/preprocess/alibaba.per_60mins.iops_p100.alibaba_9087.1"
  touch "data/flashnet/preprocess/alibaba.per_60mins.iops_p100.alibaba_9087.1/done"

@goal flashnet_characteristic_analysis
@reached_if [[ -f "data/flashnet/characteristics/analysis/alibaba/done" ]]
  python -m clio.flashnet.cli.characteristic analyze \
      raw-data/flashnet/alibaba-data-chosen/alibaba.* \
      --output "data/flashnet/characteristics/analysis/alibaba" \
      --window-size 1m
  # touch data/flashnet/characteristics/analysis/done

@goal flashnet_characteristic_split
@reached_if [[ -f "data/flashnet/characteristics/split/done" ]]
  python -m clio.flashnet.cli.characteristic split \
      raw-data/flashnet/alibaba-data-chosen/alibaba.* \
      --output "data/flashnet/characteristics/split/alibaba" \
      --window-size 1m
  touch data/flashnet/characteristics/split/done

@goal flashnet_characteristic_calculate
@reached_if [[ -f "data/flashnet/characteristics/calculate/alibaba/done" ]]
  python -m clio.flashnet.cli.characteristic calculate \
      data/flashnet/characteristics/split/alibaba \
      --characteristic "data/flashnet/characteristics/analysis/alibaba/characteristics.msgpack" \
      --output "data/flashnet/characteristics/calculate/alibaba"
  # touch data/flashnet/characteristics/calculate/done

@goal flashnet_characteristic_generate
@reached_if [[ -f "data/flashnet/characteristics/generate/alibaba/done" ]]
  python -m clio.flashnet.cli.characteristic generate \
      data/flashnet/characteristics/split/alibaba \
      --list-file "./generate-window.txt" \
      --output "data/flashnet/characteristics/generate/alibaba"
  # touch data/flashnet/characteristics/generate/alibaba/done

@goal flashnet_characteristic_generate_static_prev_df
@reached_if [[ -f "data/flashnet/characteristics/generate/alibaba/done" ]]
  python -m clio.flashnet.cli.characteristic generate \
      data/flashnet/characteristics/split/alibaba \
      --list-file "./generate-window.txt" \
      --output "data/flashnet/characteristics/generate/alibaba-static-prev-df" \
      --static-prev-df
  # touch data/flashnet/characteristics/generate/alibaba/done


# ==========================================================
# Experiment: Impact Analysis
# ==========================================================

@goal flashnet_impact_exp_size_avg_1
@reached_if [[ -f "data/flashnet/characteristics/generate/alibaba/preprocessed/size_avg.1_vs_1.5x/done" ]]
  python -m clio.flashnet.cli.impact exp \
      "data/flashnet/characteristics/generate/alibaba/preprocessed/size_avg.1_vs_1.5x" \
      --output "data/flashnet/impact/size_avg.1_vs_1.5x" \
      --window-size 1m \
      --duration 1h

@goal flashnet_impact_exp_size_avg_1_vs_1.5x_vs_7x
@reached_if [[ -f "data/flashnet/impact/alibaba/size_avg.1_vs_1.5x_vs_7x/done" ]]
  python -m clio.flashnet.cli.impact exp \
      "data/flashnet/characteristics/generate/alibaba/preprocessed/size_avg.1_vs_1.5x_vs_7x" \
      --output "data/flashnet/impact/alibaba/size_avg.1_vs_1.5x_vs_7x" \
      --window-size 1m \
      --duration 1h
  # touch "data/flashnet/impact/alibaba/single/done"
    
@goal flashnet_impact_exp_single
@reached_if [[ -f "data/flashnet/impact/alibaba/single/done" ]]
  python -m clio.flashnet.cli.impact exp \
      "data/flashnet/characteristics/generate/alibaba/preprocessed/single" \
      --output "data/flashnet/impact/alibaba/single"
      # --profile-name "profile_v1"
  # touch "data/flashnet/impact/alibaba/single/done"

# @goal flashnet_impact_exp.read_size_avg.static_prev_df.read_size_avg.1_1.5_2_3_4_5_6_7_8_9_10
# @reached_if [[ -f "data/flashnet/impact/alibaba-static-prev-df/read_size_avg.1_1.5_2_3_4_5_6_7_8_9_10/done" ]]
#   python -m clio.flashnet.cli.impact exp \
#       "data/flashnet/characteristics/generate/alibaba-static-prev-df/preprocessed/read_size_avg.1_1.5_2_3_4_5_6_7_8_9_10" \
#       --output "data/flashnet/impact/alibaba-static-prev-df/read_size_avg.1_1.5_2_3_4_5_6_7_8_9_10"

@goal flashnet_impact_exp.read_size_avg.read_size_avg.1_1.5_2_3_4_5_6_7_8_9_10
@reached_if [[ -f "data/flashnet/impact/alibaba/read_size_avg.1_1.5_2_3_4_5_6_7_8_9_10/done" ]]
  python -m clio.flashnet.cli.impact exp \
      "data/flashnet/characteristics/generate/alibaba/preprocessed/read_size_avg.1_1.5_2_3_4_5_6_7_8_9_10" \
      --output "data/flashnet/impact/alibaba/read_size_avg.1_1.5_2_3_4_5_6_7_8_9_10" \
      --cuda 1
      # --profile-name "profile_v1"
  # touch "data/flashnet/impact/alibaba/single/done"

@goal flashnet_impact_analysis.read_size_avg.1_1.5_2_3_4_5_6_7_8_9_10
  python -m clio.flashnet.cli.impact analyze \
      "data/flashnet/impact/alibaba/read_size_avg.1_1.5_2_3_4_5_6_7_8_9_10" \
      --output "data/flashnet/impact-analysis/alibaba/read_size_avg.1_1.5_2_3_4_5_6_7_8_9_10"

@goal flashnet_impact_exp.read_size_avg
@reached_if [[ -f "data/flashnet/impact/alibaba/read_size_avg/done" ]]
  python -m clio.flashnet.cli.impact exp \
      "data/flashnet/characteristics/generate/alibaba/preprocessed/read_size_avg" \
      --output "data/flashnet/impact/alibaba/read_size_avg" \
      --cuda 1
      # --profile-name "profile_v1"
  # touch "data/flashnet/impact/alibaba/single/done"

@goal flashnet_impact_analysis.read_size_avg
  python -m clio.flashnet.cli.impact analyze \
      "data/flashnet/impact/alibaba/read_size_avg" \
      --output "data/flashnet/impact-analysis/alibaba/read_size_avg"

@goal flashnet_impact_exp.read_latency_avg
@reached_if [[ -f "data/flashnet/impact/alibaba/read_latency_avg/done" ]]
  python -m clio.flashnet.cli.impact exp \
      "data/flashnet/characteristics/generate/alibaba/preprocessed/read_latency_avg" \
      --output "data/flashnet/impact/alibaba/read_latency_avg" \
      --cuda 1

@goal flashnet_impact_analysis.read_latency_avg
  python -m clio.flashnet.cli.impact analyze \
      "data/flashnet/impact/alibaba/read_latency_avg" \
      --output "data/flashnet/impact-analysis/alibaba/read_latency_avg"

@goal flashnet_impact_exp.read_iat_avg
@reached_if [[ -f "data/flashnet/impact/alibaba/read_iat_avg/done" ]]
  python -m clio.flashnet.cli.impact exp \
      "data/flashnet/characteristics/generate/alibaba/preprocessed/read_iat_avg" \
      --output "data/flashnet/impact/alibaba/read_iat_avg" \
      --cuda 1

@goal flashnet_impact_analysis.read_iat_avg
  python -m clio.flashnet.cli.impact analyze \
      "data/flashnet/impact/alibaba/read_iat_avg" \
      --output "data/flashnet/impact-analysis/alibaba/read_iat_avg"

@goal flashnet_impact_exp.read_throughput_avg
@reached_if [[ -f "data/flashnet/impact/alibaba/read_throughput_avg/done" ]]
  python -m clio.flashnet.cli.impact exp \
      "data/flashnet/characteristics/generate/alibaba/preprocessed/read_throughput_avg" \
      --output "data/flashnet/impact/alibaba/read_throughput_avg" \
      --cuda 1

@goal flashnet_impact_analysis.read_throughput_avg
  python -m clio.flashnet.cli.impact analyze \
      "data/flashnet/impact/alibaba/read_throughput_avg" \
      --output "data/flashnet/impact-analysis/alibaba/read_throughput_avg"

@goal flashnet_impact.read_throughput_avg
  ./makesure flashnet_impact_exp.read_throughput_avg
  ./makesure flashnet_impact_analysis.read_throughput_avg

# ==========================================================
# Experiment: Workload Prediction
# ==========================================================

@goal flashnet_wp
@reached_if [[ -f "data/flashnet/wp/alibaba.per_60mins.iops_p100.alibaba_9087.1/done" ]]
  export CUDA_VISIBLE_DEVICES="1"
  python -m clio.flashnet.cli.workload_prediction exp \
      "data/flashnet/preprocess/alibaba.per_60mins.iops_p100.alibaba_9087.1" \
      --output "data/analysis/flashnet/wp/alibaba.per_60mins.iops_p100.alibaba_9087.1" \
      --batch-size 32 \
      --window-size 1m \
      --duration 1h
    touch data/analysis/flashnet/wp/alibaba.per_60mins.iops_p100.alibaba_9087.1/done

@goal flashnet_workload_prediction
@reached_if [[ -f "data/analysis/flashnet/workload-prediction.window_1m.duration_1h/done" ]]
  python -m clio.flashnet.cli.workload_prediction \
      "raw-data/flashnet/generated-window/test_8_hours" \
      --output "data/analysis/flashnet/workload-prediction.window_1m.duration_1h" \
      --window-size 1m \
      --duration 1h \
      --prediction-batch-size 16384
  echo "Workload prediction done" > "data/analysis/flashnet/workload-prediction.window_1m.duration_1h/done"
